<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti贸n de Rutas de Camiones - V铆as R谩pidas</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Carga de jsPDF y jspdf-autotable para la exportaci贸n a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Estilo global para usar la fuente Inter y centrar la aplicaci贸n */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .modal.hidden { opacity: 0; visibility: hidden; }
        .modal-content { transform: translateY(100%); transition: transform 0.3s ease-out; }
        .modal.active .modal-content { transform: translateY(0); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Contenedor Principal de la Aplicaci贸n -->
    <div id="app-container" class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 md:p-10 transition-all">

        <!-- Encabezado de la Aplicaci贸n -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-blue-800"> Gestor de Rutas</h1>
            <p id="header-subtitle" class="text-gray-500 mt-1"></p>
        </header>

        <!-- Secci贸n 1: Configuraci贸n de Matr铆cula (Solo visible al inicio si falta) -->
        <div id="view-matricula-setup" class="view">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Paso 1: Identificaci贸n del Cami贸n</h2>
            <p class="mb-6 text-gray-600">Por favor, introduce la matr铆cula del cami贸n para comenzar el registro de rutas.</p>
            <input type="text" id="input-matricula" placeholder="Ej: ABC-1234" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4 uppercase">
            <button onclick="saveMatricula()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition duration-200">
                Confirmar Matr铆cula
            </button>
        </div>

        <!-- Secci贸n 2: Modo Empleado (App Principal) -->
        <div id="view-main-app" class="view hidden">
            <!-- Informaci贸n del Empleado y Matr铆cula -->
            <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg flex justify-between items-center">
                <div>
                    <p class="text-sm text-blue-600">Cami贸n Asignado:</p>
                    <p id="display-matricula" class="text-xl font-bold text-blue-800"></p>
                    <p class="text-sm text-blue-600 mt-2">Empleado Actual:</p>
                    <p id="display-employee" class="text-lg font-semibold text-gray-700"></p>
                    <p id="display-user-id" class="text-xs text-gray-400 mt-2">ID de Usuario: <span id="user-id-value"></span></p>
                </div>
                <button onclick="showChangeEmployeeModal()" class="text-blue-500 hover:text-blue-700 font-medium py-1 px-3 rounded-full border border-blue-500 hover:border-blue-700 transition duration-200 text-sm">
                    Cambiar Empleado
                </button>
            </div>

            <!-- Bot贸n de Registro de Ruta -->
            <button onclick="showRouteModal()" class="w-full bg-green-500 hover:bg-green-600 text-white font-extrabold py-4 rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.01] flex items-center justify-center text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                REGISTRAR NUEVA RUTA
            </button>

            <!-- Modo Administrador -->
            <div class="mt-8 text-center">
                <button onclick="showAdminPasswordModal()" class="text-sm text-gray-500 hover:text-red-600 transition duration-200 p-2 rounded-lg">
                    Acceso para Jefes
                </button>
            </div>
        </div>

        <!-- Secci贸n 3: Modo Administrador (Dashboard) -->
        <div id="view-admin-dashboard" class="view hidden">
            <h2 class="text-2xl font-bold text-red-700 mb-6">Panel de Administraci贸n (Jefe)</h2>

            <!-- Controles de Filtro -->
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Fecha (D铆a):</label>
                    <input type="date" id="filter-date" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Matr铆cula:</label>
                    <select id="filter-matricula" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="">Todas las Matr铆culas</option>
                        <!-- Opciones cargadas por JS -->
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="loadAdminData()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition duration-200">
                        Aplicar Filtro
                    </button>
                </div>
            </div>

            <!-- Bot贸n para Volver -->
            <button onclick="showView('view-main-app')" class="mb-4 text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
                Volver a Modo Empleado
            </button>

            <!-- Registros de la Semana Actual -->
            <h3 class="text-xl font-bold text-gray-700 mt-4 mb-3">Registros Filtrados:</h3>
            <div id="admin-results-table-container" class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Matr铆cula</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empleado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Carga</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destino</th>
                        </tr>
                    </thead>
                    <tbody id="admin-results-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Filas de datos cargadas por JS -->
                    </tbody>
                </table>
                <p id="admin-no-data" class="hidden text-center p-4 text-gray-500">No se encontraron registros para el filtro seleccionado.</p>
            </div>

            <!-- Secci贸n de Exportaci贸n a PDF por Semana y Cami贸n -->
            <h3 class="text-xl font-bold text-gray-700 mt-8 mb-4">Exportar Registros (Semanal)</h3>
            <div id="export-pdf-list" class="space-y-3">
                <p id="export-loading-message" class="text-gray-500">Cargando datos para exportaci贸n...</p>
                <!-- Botones de exportaci贸n cargados por JS -->
            </div>
        </div>

    </div>

    <!-- Modal para el Formulario de Registro de Ruta -->
    <div id="modal-route" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50 hidden">
        <div class="modal-content bg-white w-full max-w-lg rounded-t-2xl p-6 shadow-2xl">
            <h3 class="text-2xl font-bold text-green-600 mb-4">Registrar Ruta</h3>
            <form id="form-route">
                <div class="mb-4">
                    <label for="input-carga" class="block text-gray-700 font-semibold mb-1">Lugar de Carga:</label>
                    <input type="text" id="input-carga" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="mb-6">
                    <label for="input-destino" class="block text-gray-700 font-semibold mb-1">Destino:</label>
                    <input type="text" id="input-destino" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="flex justify-between space-x-3">
                    <button type="button" onclick="hideRouteModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-200">
                        Guardar Ruta
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para el Formulario de Cambio de Empleado -->
    <div id="modal-employee" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl transition-all">
            <h3 class="text-xl font-bold text-blue-600 mb-4">Cambiar Empleado</h3>
            <form id="form-employee">
                <div class="mb-4">
                    <label for="input-new-employee" class="block text-gray-700 font-semibold mb-1">Nuevo Nombre:</label>
                    <input type="text" id="input-new-employee" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideEmployeeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para la Contrase帽a de Administrador -->
    <div id="modal-admin-password" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl transition-all">
            <h3 class="text-xl font-bold text-red-600 mb-4">Acceso de Administrador</h3>
            <form id="form-admin-password">
                <div class="mb-4">
                    <label for="input-admin-password" class="block text-gray-700 font-semibold mb-1">Contrase帽a:</label>
                    <input type="password" id="input-admin-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                </div>
                <p id="admin-error-message" class="text-red-500 text-sm mb-4 hidden">Contrase帽a incorrecta.</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideAdminPasswordModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Acceder
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Mensajes (Reemplaza alert()) -->
    <div id="modal-message" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white w-full max-w-xs rounded-xl p-6 shadow-2xl transition-all">
            <h3 id="message-title" class="text-lg font-bold mb-3 text-gray-800"></h3>
            <p id="message-text" class="text-gray-600 mb-4 text-sm"></p>
            <button onclick="hideMessageModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">
                Aceptar
            </button>
        </div>
    </div>

    <!-- Carga de Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log a Debug
        setLogLevel('Debug');

        // Variables Globales
        let db, auth;
        let userId = '';
        let isAuthReady = false;

        // Variables de la App (Estado)
        let currentMatricula = '';
        let currentEmployee = '';

        // Constantes Globales (proporcionadas por el entorno)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Utilidades de UI ---

        /** Muestra un modal de mensaje (reemplaza a alert()) */
        window.showMessageModal = (title, message) => {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = message;
            const modal = document.getElementById('modal-message');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
        }

        /** Oculta el modal de mensaje */
        window.hideMessageModal = () => {
            const modal = document.getElementById('modal-message');
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        /** Muestra la vista de la app */
        window.showView = (viewName) => {
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            document.getElementById(viewName).classList.remove('hidden');

            if (viewName === 'view-main-app') {
                document.getElementById('header-subtitle').textContent = `Matr铆cula: ${currentMatricula} | Empleado: ${currentEmployee}`;
            } else if (viewName === 'view-matricula-setup') {
                 document.getElementById('header-subtitle').textContent = `Bienvenido.`;
            } else if (viewName === 'view-admin-dashboard') {
                 document.getElementById('header-subtitle').textContent = `Modo Jefe (Matr铆cula: ${currentMatricula})`;
                 // Cargar datos por defecto al entrar al modo admin
                 loadAdminData();
            }
        }

        /** Muestra el modal de registro de ruta */
        window.showRouteModal = () => {
            const modal = document.getElementById('modal-route');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
            document.getElementById('input-carga').focus();
        }

        /** Oculta el modal de registro de ruta */
        window.hideRouteModal = () => {
            const modal = document.getElementById('modal-route');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('form-route').reset();
            }, 300);
        }

        /** Muestra el modal de cambio de empleado */
        window.showChangeEmployeeModal = () => {
            document.getElementById('input-new-employee').value = currentEmployee;
            const modal = document.getElementById('modal-employee');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
            document.getElementById('input-new-employee').focus();
        }

        /** Oculta el modal de cambio de empleado */
        window.hideEmployeeModal = () => {
            const modal = document.getElementById('modal-employee');
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        /** Muestra el modal de contrase帽a de administrador */
        window.showAdminPasswordModal = () => {
            document.getElementById('admin-error-message').classList.add('hidden');
            document.getElementById('input-admin-password').value = '';
            const modal = document.getElementById('modal-admin-password');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
            document.getElementById('input-admin-password').focus();
        }

        /** Oculta el modal de contrase帽a de administrador */
        window.hideAdminPasswordModal = () => {
            const modal = document.getElementById('modal-admin-password');
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }


        // --- Funciones de Firebase ---

        /** Inicializa Firebase y autentica al usuario. */
        const setupFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config no est谩 disponible. Usando configuraci贸n por defecto.");
                    showMessageModal("Error de Configuraci贸n", "La configuraci贸n de Firebase no est谩 disponible.");
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticaci贸n: Prioriza el token, sino, usa an贸nimo.
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listener para el estado de autenticaci贸n
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-value').textContent = userId;
                        console.log("Usuario autenticado con UID:", userId);
                        loadInitialConfig();
                    } else {
                        console.log("Usuario no autenticado.");
                        userId = '';
                        isAuthReady = true;
                    }
                });
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                showMessageModal("Error de Inicializaci贸n", "Fallo al conectar con la base de datos.");
            }
        };

        /** Carga la 煤ltima Matr铆cula y Empleado guardados. */
        const loadInitialConfig = async () => {
            if (!isAuthReady || !userId || !db) return;

            const configRef = doc(db, 'artifacts', appId, 'users', userId, 'config', 'user_data');
            try {
                const docSnap = await getDoc(configRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentMatricula = data.matricula || '';
                    currentEmployee = data.employee || '';
                }

                if (!currentMatricula) {
                    showView('view-matricula-setup');
                } else {
                    // Si ya tiene matr铆cula, debe tener un empleado.
                    if (!currentEmployee) currentEmployee = 'Conductor sin Nombre';
                    updateEmployeeDisplay();
                    showView('view-main-app');
                }
            } catch (error) {
                console.error("Error al cargar la configuraci贸n inicial:", error);
            }
        }

        /** Guarda la matr铆cula y actualiza la vista. */
        window.saveMatricula = async () => {
            const input = document.getElementById('input-matricula');
            const matricula = input.value.trim().toUpperCase();

            if (!matricula || !isAuthReady || !db) {
                showMessageModal("Error", "Por favor, introduce una matr铆cula v谩lida.");
                return;
            }

            currentMatricula = matricula;

            // Tambi茅n actualizamos el nombre del empleado a un valor por defecto si no existe
            if (!currentEmployee) {
                currentEmployee = 'Conductor sin Nombre';
            }

            await saveUserConfig();
            updateEmployeeDisplay();
            showView('view-main-app');
        }

        /** Actualiza el nombre del empleado. */
        window.updateEmployeeName = async (event) => {
            event.preventDefault();
            const input = document.getElementById('input-new-employee');
            const newEmployee = input.value.trim();

            if (!newEmployee || !isAuthReady || !db) {
                showMessageModal("Error", "Por favor, introduce un nombre de empleado.");
                return;
            }

            currentEmployee = newEmployee;
            await saveUserConfig();
            updateEmployeeDisplay();
            hideEmployeeModal();
            showMessageModal("xito", `Nombre de empleado actualizado a: ${currentEmployee}`);
        }

        /** Guarda la Matr铆cula y el Empleado en la configuraci贸n privada del usuario. */
        const saveUserConfig = async () => {
             if (!isAuthReady || !userId || !db) return;

             const configRef = doc(db, 'artifacts', appId, 'users', userId, 'config', 'user_data');
             try {
                 await setDoc(configRef, {
                     matricula: currentMatricula,
                     employee: currentEmployee,
                     lastUpdated: new Date().toISOString()
                 }, { merge: true });
                 console.log("Configuraci贸n de usuario guardada.");
             } catch (error) {
                 console.error("Error al guardar la configuraci贸n de usuario:", error);
             }
        }

        /** Actualiza los elementos de la UI con la matr铆cula y el empleado actuales. */
        const updateEmployeeDisplay = () => {
            document.getElementById('display-matricula').textContent = currentMatricula;
            document.getElementById('display-employee').textContent = currentEmployee;
        }

        /** Guarda un nuevo registro de ruta en Firestore. */
        window.saveRoute = async (event) => {
            event.preventDefault();

            if (!currentMatricula || !currentEmployee) {
                 showMessageModal("Error", "Falta informaci贸n (Matr铆cula o Empleado). Por favor, repasa la configuraci贸n.");
                 return;
            }

            const carga = document.getElementById('input-carga').value.trim();
            const destino = document.getElementById('input-destino').value.trim();

            if (!carga || !destino) {
                showMessageModal("Error", "Ambos campos (Carga y Destino) son obligatorios.");
                return;
            }
            
            // Usamos local date getters para crear la cadena YYYY-MM-DD
            const now = new Date();
            const dateString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            const routeData = {
                matricula: currentMatricula,
                employee: currentEmployee,
                carga: carga,
                destino: destino,
                timestamp: now.getTime(), // Para orden y referencia
                dateString: dateString, // YYYY-MM-DD (para un filtrado consistente)
                registerByUserId: userId
            };

            try {
                const publicCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'rutas_camiones');
                await addDoc(publicCollectionRef, routeData);
                
                hideRouteModal();
                showMessageModal("Ruta Registrada", `Ruta de ${carga} a ${destino} guardada con 茅xito para el cami贸n ${currentMatricula}.`);
                document.getElementById('form-route').reset();
            } catch (error) {
                console.error("Error al guardar la ruta:", error);
                showMessageModal("Error de Base de Datos", "No se pudo guardar la ruta. Int茅ntalo de nuevo.");
            }
        }

        /** Verifica la contrase帽a de Administrador. */
        window.checkAdminPassword = (event) => {
            event.preventDefault();
            const input = document.getElementById('input-admin-password');
            const password = input.value;
            const errorMessage = document.getElementById('admin-error-message');

            const ADMIN_PASSWORD = "VALENTIN"; // Contrase帽a requerida

            if (password === ADMIN_PASSWORD) {
                hideAdminPasswordModal();
                showView('view-admin-dashboard');
                // loadAdminData() se llama dentro de showView
            } else {
                errorMessage.classList.remove('hidden');
            }
        }

        /** Carga y filtra los datos para el Admin Dashboard. */
        window.loadAdminData = async () => {
            if (!isAuthReady || !db) return;
            
            // Muestra el mensaje de carga en la secci贸n de exportaci贸n
            document.getElementById('export-loading-message').classList.remove('hidden');
            document.getElementById('export-pdf-list').innerHTML = ''; // Limpiar opciones

            const selectedDate = document.getElementById('filter-date').value;
            const selectedMatricula = document.getElementById('filter-matricula').value;

            const publicCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'rutas_camiones');
            
            try {
                const snapshot = await getDocs(publicCollectionRef);
                let allData = [];
                let matriculas = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allData.push(data);
                    matriculas.add(data.matricula);
                });
                
                // 1. Llenar el select de matr铆culas
                const filterSelect = document.getElementById('filter-matricula');
                if (filterSelect.options.length <= 1 || matriculas.size !== filterSelect.options.length - 1) { 
                     while (filterSelect.options.length > 1) {
                         filterSelect.remove(1);
                     }
                     matriculas.forEach(m => {
                         const option = document.createElement('option');
                         option.value = m;
                         option.textContent = m;
                         filterSelect.appendChild(option);
                     });
                     filterSelect.value = selectedMatricula; // Restaurar el valor del filtro
                }
                
                // 2. Filtrado en memoria para la tabla
                let filteredData = allData.filter(item => {
                    // Filtrar por fecha (YYYY-MM-DD)
                    const dateMatch = !selectedDate || item.dateString === selectedDate;
                    // Filtrar por matr铆cula
                    const matriculaMatch = !selectedMatricula || item.matricula === selectedMatricula;
                    return dateMatch && matriculaMatch;
                });

                renderAdminTable(filteredData);

                // 3. Preparar los botones de Exportaci贸n (usa ALL data, no solo la filtrada)
                preparePDFExportOptions(allData); 

            } catch (error) {
                console.error("Error al cargar datos de administrador:", error);
                showMessageModal("Error", "No se pudieron cargar los registros de rutas.");
                document.getElementById('export-pdf-list').innerHTML = '<p class="text-red-500">Error al cargar datos para exportaci贸n.</p>';
            }
        }

        /** Renderiza la tabla de resultados del Admin. */
        const renderAdminTable = (data) => {
            const tbody = document.getElementById('admin-results-table-body');
            tbody.innerHTML = '';
            const noDataMessage = document.getElementById('admin-no-data');

            if (data.length === 0) {
                noDataMessage.classList.remove('hidden');
                return;
            }
            noDataMessage.classList.add('hidden');

            data.sort((a, b) => b.timestamp - a.timestamp); // Ordenar por m谩s reciente

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(item.timestamp).toLocaleDateString('es-ES')} ${new Date(item.timestamp).toLocaleTimeString('es-ES').substring(0, 5)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">${item.matricula}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.employee}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.carga}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.destino}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // --- L贸gica de Exportaci贸n a PDF ---

        /** Helper: Convierte YYYY-MM-DD a un objeto Date LOCAL en medianoche (00:00:00). 
         * Esto es crucial para que el rango de fechas sea consistente sin importar la zona horaria del cliente. */
        const parseLocalMidnight = (dateString) => {
            if (!dateString) return null;
            const parts = dateString.split('-'); // YYYY-MM-DD
            // Date(year, monthIndex, day) - esto garantiza que se use la hora local
            return new Date(parts[0], parts[1] - 1, parts[2]); 
        }

        /** Obtiene el inicio de la semana (Lunes) de una fecha, asegurando 00:00:00 (Local Time). */
        const getStartOfWeek = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0); // Limpiar tiempo

            let day = d.getDay(); // 0 = Domingo, 1 = Lunes, ..., 6 = S谩bado
            // Convertir a est谩ndar ISO (Lunes = 0, Domingo = 6)
            day = day === 0 ? 6 : day - 1; 

            // Restar d铆as para llegar al lunes
            const diff = d.getDate() - day;

            return new Date(d.setDate(diff)); // Retorna el Lunes a 00:00:00 local
        }

        /** Agrupa la data por Matr铆cula y Semana y genera los botones de exportaci贸n. */
        const preparePDFExportOptions = (allData) => {
            const container = document.getElementById('export-pdf-list');
            container.innerHTML = '';
            document.getElementById('export-loading-message').classList.add('hidden');

            if (allData.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No hay registros para exportar.</p>';
                return;
            }

            const groupedData = {};

            allData.forEach(item => {
                // Se usa la fecha del item (timestamp) para obtener el inicio de la semana
                const date = new Date(item.timestamp);
                const startDateObject = getStartOfWeek(date); // Lunes 00:00:00 local
                
                // Formato YYYY-MM-DD usando getters locales
                const startOfWeek = `${startDateObject.getFullYear()}-${String(startDateObject.getMonth() + 1).padStart(2, '0')}-${String(startDateObject.getDate()).padStart(2, '0')}`;
                
                const endOfWeekDate = new Date(startDateObject);
                endOfWeekDate.setDate(startDateObject.getDate() + 6); // Domingo de esa semana
                const endOfWeek = `${endOfWeekDate.getFullYear()}-${String(endOfWeekDate.getMonth() + 1).padStart(2, '0')}-${String(endOfWeekDate.getDate()).padStart(2, '0')}`;

                const key = `${item.matricula}_${startOfWeek}`;

                if (!groupedData[key]) {
                    groupedData[key] = {
                        matricula: item.matricula,
                        startOfWeek: startOfWeek,
                        endOfWeek: endOfWeek,
                        records: []
                    };
                }
                groupedData[key].records.push(item);
            });

            // Ordenar grupos por fecha descendente
            const sortedKeys = Object.keys(groupedData).sort((a, b) => {
                const dateA = parseLocalMidnight(groupedData[a].startOfWeek);
                const dateB = parseLocalMidnight(groupedData[b].startOfWeek);
                return dateB.getTime() - dateA.getTime();
            });
            
            // Generar los botones
            sortedKeys.forEach(key => {
                const group = groupedData[key];
                
                const div = document.createElement('div');
                div.className = 'flex flex-col md:flex-row justify-between items-center p-3 bg-white border border-gray-200 rounded-lg shadow-sm';
                div.innerHTML = `
                    <p class="font-medium text-gray-700 mb-2 md:mb-0 text-sm md:text-base">
                        <span class="font-extrabold text-blue-700 mr-2">${group.matricula}</span>
                        | Semana: ${parseLocalMidnight(group.startOfWeek).toLocaleDateString('es-ES')} al ${parseLocalMidnight(group.endOfWeek).toLocaleDateString('es-ES')}
                        <span class="text-xs text-gray-500">(${group.records.length} rutas)</span>
                    </p>
                    <button 
                        onclick="generateWeeklyPDF('${group.matricula}', '${group.startOfWeek}')"
                        class="flex items-center bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm w-full md:w-auto"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-2.25A3.375 3.375 0 0010.5 11.625v2.625m-7.5 1.5h15m-14.5-5.625a.375.375 0 11.75 0 .375.375 0 01-.75 0zm7.5 0a.375.375 0 11.75 0 .375.375 0 01-.75 0z" />
                        </svg>
                        Exportar PDF
                    </button>
                `;
                container.appendChild(div);
            });
        }

        /** Genera el PDF Semanal para una Matr铆cula y Semana espec铆fica. */
        window.generateWeeklyPDF = (matricula, startOfWeek) => {
            const publicCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'rutas_camiones');

            getDocs(publicCollectionRef).then(snapshot => {
                let allData = [];
                snapshot.forEach(doc => allData.push(doc.data()));

                // Usar el parser para obtener una fecha local consistente (Lunes 00:00:00)
                const startDate = parseLocalMidnight(startOfWeek);
                if (!startDate) {
                     showMessageModal("Error de Fecha", "Fallo al determinar el inicio de la semana.");
                     return;
                }

                // Calcular la fecha final: Lunes de la pr贸xima semana a medianoche (exclusivo)
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 7); 

                // Filtrar registros
                const weeklyRecords = allData.filter(item => {
                    // Usar el parser para obtener la fecha de registro local consistente (D铆a 00:00:00)
                    // item.dateString fue guardado como YYYY-MM-DD
                    const itemDate = parseLocalMidnight(item.dateString); 
                    if (!itemDate) return false;

                    // Filtrar por matr铆cula y por rango de fechas [startDate, endDate)
                    return item.matricula === matricula && itemDate.getTime() >= startDate.getTime() && itemDate.getTime() < endDate.getTime();
                }).sort((a, b) => a.timestamp - b.timestamp); // Ordenar cronol贸gicamente
                
                if (weeklyRecords.length === 0) {
                    showMessageModal("Error", "No se encontraron registros en el rango de fechas especificado para esta matr铆cula.");
                    return;
                }
                
                try {
                    // Inicializar jsPDF
                    // @ts-ignore
                    const doc = new window.jspdf.jsPDF();
                    
                    const startOfWeekStr = startDate.toLocaleDateString('es-ES');
                    
                    const displayEndDate = new Date(endDate);
                    displayEndDate.setDate(displayEndDate.getDate() - 1); // Restar un d铆a para mostrar el domingo
                    const endOfWeekStr = displayEndDate.toLocaleDateString('es-ES');

                    // Encabezado
                    doc.setFontSize(18);
                    doc.text(`Reporte Semanal de Rutas`, 14, 22);
                    doc.setFontSize(12);
                    doc.text(`Matr铆cula: ${matricula}`, 14, 30);
                    doc.text(`Per铆odo: ${startOfWeekStr} - ${endOfWeekStr}`, 14, 37);
                    doc.setFontSize(10);
                    doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES')}`, 14, 44);

                    // Preparar datos para la tabla
                    const tableColumn = ["Fecha y Hora", "Empleado", "Carga", "Destino"];
                    const tableRows = [];

                    weeklyRecords.forEach(record => {
                        const date = new Date(record.timestamp);
                        tableRows.push([
                            date.toLocaleDateString('es-ES') + ' ' + date.toLocaleTimeString('es-ES').substring(0, 5),
                            record.employee,
                            record.carga,
                            record.destino
                        ]);
                    });

                    // Generar tabla
                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 50,
                        headStyles: { fillColor: [30, 64, 175] }, // Azul oscuro para encabezados
                        styles: { fontSize: 8 },
                        margin: { top: 50 }
                    });

                    // Nombre del archivo: MATRICULA_SEMANA_INI.pdf
                    const fileName = `${matricula}_SEMANA_${startOfWeek}.pdf`;
                    doc.save(fileName);
                    showMessageModal("Exportaci贸n Exitosa", `Se ha generado el archivo PDF: ${fileName}`);

                } catch (error) {
                    console.error("Error durante la generaci贸n del PDF:", error);
                    showMessageModal("Error de PDF", "Hubo un error al crear el documento PDF. Consulta la consola para detalles.");
                }

            }).catch(error => {
                console.error("Error al obtener datos para PDF:", error);
                showMessageModal("Error de Exportaci贸n", "Hubo un error al preparar los datos para el PDF desde la base de datos.");
            });
        }
        
        // --- Event Listeners ---

        document.getElementById('form-route').addEventListener('submit', window.saveRoute);
        document.getElementById('form-employee').addEventListener('submit', window.updateEmployeeName);
        document.getElementById('form-admin-password').addEventListener('submit', window.checkAdminPassword);
        
        // --- Inicio de la Aplicaci贸n ---
        window.onload = setupFirebase;

    </script>
</body>
</html>


