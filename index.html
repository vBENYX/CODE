<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti贸n de Rutas Centralizada - Firestore</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Carga de jsPDF y jspdf-autotable para la exportaci贸n a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Estilo global para usar la fuente Inter y centrar la aplicaci贸n */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .modal.hidden { opacity: 0; visibility: hidden; }
        .modal-content { transform: translateY(100%); transition: transform 0.3s ease-out; }
        .modal.active .modal-content { transform: translateY(0); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Contenedor Principal de la Aplicaci贸n -->
    <div id="app-container" class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 md:p-10 transition-all">

        <!-- Encabezado de la Aplicaci贸n -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-blue-800"> Gestor de Rutas Centralizado</h1>
            <p id="header-subtitle" class="text-gray-500 mt-1"></p>
        </header>

        <!-- Indicador de Carga Inicial -->
        <div id="loading-view" class="flex flex-col items-center justify-center p-12 text-blue-600">
            <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 font-semibold">Cargando datos y autenticaci贸n...</p>
        </div>
        
        <!-- Secci贸n 1: Configuraci贸n de Matr铆cula (Solo visible al inicio si falta) -->
        <div id="view-matricula-setup" class="view hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Paso 1: Identificaci贸n del Cami贸n</h2>
            <p class="mb-6 text-gray-600">Introduce la matr铆cula y el nombre del conductor para vincular este dispositivo a la base de datos central.</p>
            <input type="text" id="input-matricula" placeholder="Ej: ABC-1234" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4 uppercase">
             <input type="text" id="input-employee-name-setup" placeholder="Nombre del Conductor" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4">
            <button onclick="saveMatricula()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition duration-200">
                Confirmar y Acceder
            </button>
        </div>

        <!-- Secci贸n 2: Modo Empleado (App Principal) -->
        <div id="view-main-app" class="view hidden">
            <!-- Informaci贸n del Empleado y Matr铆cula -->
            <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg flex justify-between items-center">
                <div>
                    <p class="text-sm text-blue-600">Cami贸n Asignado:</p>
                    <p id="display-matricula" class="text-xl font-bold text-blue-800"></p>
                    <p class="text-sm text-blue-600 mt-2">Conductor Actual:</p>
                    <p id="display-employee" class="text-lg font-semibold text-gray-700"></p>
                    <p id="display-user-id" class="text-xs text-gray-400 mt-2">ID de Sesi贸n (Firestore): <span id="user-id-value"></span></p>
                </div>
                <button onclick="showChangeEmployeeModal()" class="text-blue-500 hover:text-blue-700 font-medium py-1 px-3 rounded-full border border-blue-500 hover:border-blue-700 transition duration-200 text-sm">
                    Cambiar Conductor
                </button>
            </div>

            <!-- Bot贸n de Registro de Ruta -->
            <button onclick="showRouteModal()" class="w-full bg-green-500 hover:bg-green-600 text-white font-extrabold py-4 rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.01] flex items-center justify-center text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                REGISTRAR NUEVA RUTA
            </button>

            <!-- Modo Administrador -->
            <div class="mt-8 text-center">
                <button onclick="showAdminPasswordModal()" class="text-sm text-gray-500 hover:text-red-600 transition duration-200 p-2 rounded-lg">
                    Acceso para Jefes (Administraci贸n)
                </button>
            </div>
        </div>

        <!-- Secci贸n 3: Modo Administrador (Dashboard) -->
        <div id="view-admin-dashboard" class="view hidden">
            <h2 class="text-2xl font-bold text-red-700 mb-6">Panel de Administraci贸n (Jefe)</h2>

            <!-- Controles de Filtro -->
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Fecha (D铆a):</label>
                    <input type="date" id="filter-date" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Matr铆cula:</label>
                    <select id="filter-matricula" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="">Todas las Matr铆culas</option>
                        <!-- Opciones cargadas por JS -->
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="applyAdminFilters()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition duration-200">
                        Aplicar Filtro
                    </button>
                </div>
            </div>

            <!-- Bot贸n para Volver -->
            <button onclick="showView('view-main-app')" class="mb-4 text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
                Volver a Modo Conductor
            </button>

            <!-- Registros de la Semana Actual -->
            <h3 class="text-xl font-bold text-gray-700 mt-4 mb-3">Registros Filtrados:</h3>
            <div id="admin-results-table-container" class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Matr铆cula</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conductor</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Carga</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destino</th>
                        </tr>
                    </thead>
                    <tbody id="admin-results-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Filas de datos cargadas por JS -->
                    </tbody>
                </table>
                <p id="admin-no-data" class="hidden text-center p-4 text-gray-500">No se encontraron registros para el filtro seleccionado.</p>
            </div>

            <!-- Secci贸n de Exportaci贸n a PDF por Semana y Cami贸n -->
            <h3 class="text-xl font-bold text-gray-700 mt-8 mb-4">Exportar Registros (Semanal)</h3>
            <div id="export-pdf-list" class="space-y-3">
                <p id="export-loading-message" class="text-gray-500">Cargando opciones de exportaci贸n...</p>
                <!-- Botones de exportaci贸n cargados por JS -->
            </div>
        </div>

    </div>

    <!-- Modals (Sin cambios en funcionalidad de UI) -->
    <!-- Modal para el Formulario de Registro de Ruta -->
    <div id="modal-route" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50 hidden">
        <div class="modal-content bg-white w-full max-w-lg rounded-t-2xl p-6 shadow-2xl">
            <h3 class="text-2xl font-bold text-green-600 mb-4">Registrar Ruta</h3>
            <form id="form-route">
                <div class="mb-4">
                    <label for="input-carga" class="block text-gray-700 font-semibold mb-1">Lugar de Carga:</label>
                    <input type="text" id="input-carga" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="mb-6">
                    <label for="input-destino" class="block text-gray-700 font-semibold mb-1">Destino:</label>
                    <input type="text" id="input-destino" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="flex justify-between space-x-3">
                    <button type="button" onclick="hideRouteModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-200">
                        Guardar Ruta
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para el Formulario de Cambio de Empleado -->
    <div id="modal-employee" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl transition-all">
            <h3 class="text-xl font-bold text-blue-600 mb-4">Cambiar Conductor</h3>
            <form id="form-employee">
                <div class="mb-4">
                    <label for="input-new-employee" class="block text-gray-700 font-semibold mb-1">Nuevo Nombre:</label>
                    <input type="text" id="input-new-employee" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideEmployeeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para la Contrase帽a de Administrador -->
    <div id="modal-admin-password" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl transition-all">
            <h3 class="text-xl font-bold text-red-600 mb-4">Acceso de Administrador</h3>
            <form id="form-admin-password">
                <div class="mb-4">
                    <label for="input-admin-password" class="block text-gray-700 font-semibold mb-1">Contrase帽a:</label>
                    <input type="password" id="input-admin-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                </div>
                <p id="admin-error-message" class="text-red-500 text-sm mb-4 hidden">Contrase帽a incorrecta.</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideAdminPasswordModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Acceder
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Mensajes (Reemplaza alert()) -->
    <div id="modal-message" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white w-full max-w-xs rounded-xl p-6 shadow-2xl transition-all">
            <h3 id="message-title" class="text-lg font-bold mb-3 text-gray-800"></h3>
            <p id="message-text" class="text-gray-600 mb-4 text-sm"></p>
            <button onclick="hideMessageModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">
                Aceptar
            </button>
        </div>
    </div>

    <!-- Script de la Aplicaci贸n (USA FIREBASE/FIRESTORE) -->
    <script type="module">
        // Importaciones de Firebase (requiere type="module" en el script)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            addDoc, 
            collection, 
            onSnapshot, 
            query, 
            where 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // setLogLevel('Debug'); // Descomentar para ver logs de Firebase

        // Variables de la App (Estado)
        let currentMatricula = '';
        let currentEmployee = '';
        let currentUserId = '';
        let isAuthReady = false;
        let allRoutesData = []; // Datos de todas las rutas desde Firestore (para Admin)
        let routeSnapshotUnsubscribe = null; // Para detener la escucha de Firestore

        // Clave de Configuraci贸n Local (para guardar la matr铆cula y el empleado en este dispositivo)
        const LOCAL_CONFIG_KEY = 'truck_app_config_firestore';
        
        // Variables globales de Firebase (Provistas por el entorno)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Instancias de Firebase
        let app, db, auth;

        // --- Utilidades de UI ---

        /** Muestra un modal de mensaje (reemplaza a alert()) */
        window.showMessageModal = (title, message) => {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = message;
            const modal = document.getElementById('modal-message');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
        }

        /** Oculta el modal de mensaje */
        window.hideMessageModal = () => {
            const modal = document.getElementById('modal-message');
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        /** Muestra la vista de la app */
        window.showView = (viewName) => {
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            document.getElementById('loading-view').classList.add('hidden');
            document.getElementById(viewName).classList.remove('hidden');

            if (viewName === 'view-main-app') {
                document.getElementById('header-subtitle').textContent = `Matr铆cula: ${currentMatricula} | Conductor: ${currentEmployee}`;
            } else if (viewName === 'view-matricula-setup') {
                 document.getElementById('header-subtitle').textContent = `Bienvenido.`;
            } else if (viewName === 'view-admin-dashboard') {
                 document.getElementById('header-subtitle').textContent = `Modo Jefe (Todos los datos)`;
                 // Recargar datos al entrar en modo admin
                 applyAdminFilters();
            }
        }

        // --- Funciones de Modales (Misma l贸gica que antes) ---
        window.showRouteModal = () => {
            document.getElementById('modal-route').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-route').classList.add('active'), 10);
        }
        window.hideRouteModal = () => {
            document.getElementById('modal-route').classList.remove('active');
            setTimeout(() => document.getElementById('modal-route').classList.add('hidden'), 300);
            document.getElementById('form-route').reset();
        }
        window.showChangeEmployeeModal = () => {
            document.getElementById('input-new-employee').value = currentEmployee;
            document.getElementById('modal-employee').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-employee').classList.add('active'), 10);
        }
        window.hideEmployeeModal = () => {
            document.getElementById('modal-employee').classList.remove('active');
            setTimeout(() => document.getElementById('modal-employee').classList.add('hidden'), 300);
        }
        window.showAdminPasswordModal = () => {
            document.getElementById('admin-error-message').classList.add('hidden');
            document.getElementById('input-admin-password').value = '';
            document.getElementById('modal-admin-password').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-admin-password').classList.add('active'), 10);
        }
        window.hideAdminPasswordModal = () => {
            document.getElementById('modal-admin-password').classList.remove('active');
            setTimeout(() => document.getElementById('modal-admin-password').classList.add('hidden'), 300);
        }


        // --- Autenticaci贸n y Configuraci贸n de Firebase ---

        const initializeFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config not available.");
                showMessageModal("Error Fatal", "No se pudo cargar la configuraci贸n de Firebase.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Escuchar cambios de autenticaci贸n
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        loadLocalConfig();
                        // Una vez autenticado, iniciar la escucha de datos del Admin
                        startRouteSnapshotListener(); 
                    } else {
                        // Intentar autenticaci贸n (o fallar si no hay token)
                        handleInitialAuth();
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                showMessageModal("Error de Inicializaci贸n", "Fallo al conectar con la base de datos central.");
            }
        }
        
        const handleInitialAuth = async () => {
             // 2. Firmar sesi贸n con token personalizado (si est谩 disponible) o an贸nimamente
             try {
                 if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                 } else {
                    await signInAnonymously(auth);
                 }
                 // onAuthStateChanged manejar谩 el resto
             } catch (error) {
                 console.error("Error de autenticaci贸n:", error);
                 showMessageModal("Error de Auth", "No se pudo iniciar sesi贸n. Int茅ntalo de nuevo.");
             }
        }
        
        /** Carga la matr铆cula y el empleado guardados localmente para este dispositivo. */
        const loadLocalConfig = () => {
             // Intentar cargar la configuraci贸n local (Matr铆cula y Conductor)
            const configString = localStorage.getItem(LOCAL_CONFIG_KEY);
            let config = {};
            try {
                config = JSON.parse(configString) || {};
            } catch (e) {
                console.error("Error parsing config from localStorage", e);
            }
            
            currentMatricula = config.matricula || '';
            currentEmployee = config.employee || '';
            
            updateEmployeeDisplay();

            if (!currentMatricula || !currentEmployee) {
                showView('view-matricula-setup');
            } else {
                showView('view-main-app');
            }
        }

        /** Guarda la Matr铆cula y el Empleado localmente. */
        window.saveMatricula = () => {
            const inputMatricula = document.getElementById('input-matricula');
            const inputEmployee = document.getElementById('input-employee-name-setup');
            const matricula = inputMatricula.value.trim().toUpperCase();
            const employee = inputEmployee.value.trim();

            if (!matricula || !employee) {
                showMessageModal("Error", "Por favor, introduce la matr铆cula y el nombre del conductor.");
                return;
            }

            currentMatricula = matricula;
            currentEmployee = employee;

            const configData = {
                 matricula: currentMatricula,
                 employee: currentEmployee,
                 userId: currentUserId 
            };
            localStorage.setItem(LOCAL_CONFIG_KEY, JSON.stringify(configData));

            updateEmployeeDisplay();
            showView('view-main-app');
        }

        /** Actualiza el nombre del empleado (y guarda localmente). */
        window.updateEmployeeName = (event) => {
            event.preventDefault();
            const input = document.getElementById('input-new-employee');
            const newEmployee = input.value.trim();

            if (!newEmployee) {
                showMessageModal("Error", "Por favor, introduce un nombre de conductor.");
                return;
            }

            currentEmployee = newEmployee;
            
            // Guardar en localStorage
            const configData = { matricula: currentMatricula, employee: currentEmployee, userId: currentUserId };
            localStorage.setItem(LOCAL_CONFIG_KEY, JSON.stringify(configData));

            updateEmployeeDisplay();
            hideEmployeeModal();
            showMessageModal("xito", `Conductor actualizado a: ${currentEmployee}`);
        }

        /** Actualiza los elementos de la UI con la matr铆cula y el empleado actuales. */
        const updateEmployeeDisplay = () => {
            document.getElementById('display-matricula').textContent = currentMatricula;
            document.getElementById('display-employee').textContent = currentEmployee;
            document.getElementById('user-id-value').textContent = currentUserId;
        }


        // --- Firestore: Guardar Ruta (Escribir en la colecci贸n p煤blica) ---
        
        /** Obtiene la referencia a la colecci贸n de rutas p煤blicas */
        const getRoutesCollectionRef = () => {
            // Colecci贸n p煤blica: /artifacts/{appId}/public/data/truck_routes
            return collection(db, 'artifacts', appId, 'public', 'data', 'truck_routes');
        }

        /** Guarda un nuevo registro de ruta en Firestore. */
        window.saveRoute = async (event) => {
            event.preventDefault();

            if (!isAuthReady || !db) {
                 showMessageModal("Error", "La conexi贸n a la base de datos no est谩 lista. Intenta de nuevo.");
                 return;
            }

            const carga = document.getElementById('input-carga').value.trim();
            const destino = document.getElementById('input-destino').value.trim();

            if (!carga || !destino) {
                showMessageModal("Error", "Ambos campos (Carga y Destino) son obligatorios.");
                return;
            }
            
            const now = new Date();
            const dateString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            const routeData = {
                matricula: currentMatricula,
                employee: currentEmployee,
                carga: carga,
                destino: destino,
                timestamp: now.getTime(), // Unix epoch para orden
                dateString: dateString, // YYYY-MM-DD para filtrado
                userId: currentUserId
            };

            try {
                await addDoc(getRoutesCollectionRef(), routeData);
                
                hideRouteModal();
                showMessageModal("Ruta Registrada", `Ruta guardada en la base de datos central para ${currentMatricula}.`);
                document.getElementById('form-route').reset();
            } catch (error) {
                console.error("Error al guardar la ruta en Firestore:", error);
                showMessageModal("Error de Base de Datos", "No se pudo guardar la ruta centralmente.");
            }
        }

        // --- Firestore: Admin Dashboard (Leer la colecci贸n p煤blica) ---
        
        /** Inicia la escucha en tiempo real de TODAS las rutas para el Admin Dashboard. */
        const startRouteSnapshotListener = () => {
            if (!isAuthReady || !db || routeSnapshotUnsubscribe) return;
            
            // Query para traer todos los documentos de la colecci贸n p煤blica
            const q = query(getRoutesCollectionRef());
            
            // onSnapshot se mantiene escuchando los cambios en tiempo real
            routeSnapshotUnsubscribe = onSnapshot(q, (snapshot) => {
                const newRoutes = [];
                snapshot.forEach(doc => {
                    newRoutes.push({ id: doc.id, ...doc.data() });
                });
                
                allRoutesData = newRoutes;
                
                // Si estamos en la vista de administraci贸n, actualizamos
                if (!document.getElementById('view-admin-dashboard').classList.contains('hidden')) {
                     applyAdminFilters();
                }

                // Generamos las opciones de exportaci贸n tan pronto como tengamos datos
                preparePDFExportOptions(allRoutesData);

            }, (error) => {
                console.error("Error al obtener datos en tiempo real:", error);
                // Detener la escucha si hay un error
                if (routeSnapshotUnsubscribe) routeSnapshotUnsubscribe();
                routeSnapshotUnsubscribe = null;
            });
            console.log("Escuchando cambios en Firestore...");
        }

        /** Verifica la contrase帽a de Administrador. */
        window.checkAdminPassword = (event) => {
            event.preventDefault();
            const input = document.getElementById('input-admin-password');
            const password = input.value;
            const errorMessage = document.getElementById('admin-error-message');

            const ADMIN_PASSWORD = "VALENTIN"; 

            if (password === ADMIN_PASSWORD) {
                hideAdminPasswordModal();
                showView('view-admin-dashboard');
                // La funci贸n applyAdminFilters() se llama dentro de showView('view-admin-dashboard')
            } else {
                errorMessage.classList.remove('hidden');
            }
        }
        
        /** Aplica los filtros a los datos cargados y actualiza la tabla. */
        window.applyAdminFilters = () => {
            const selectedDate = document.getElementById('filter-date').value;
            const selectedMatricula = document.getElementById('filter-matricula').value;

            // 1. Llenar el select de matr铆culas basado en los datos cargados
            const matriculas = new Set(allRoutesData.map(data => data.matricula));
            const filterSelect = document.getElementById('filter-matricula');
            
            // Actualizar opciones si es necesario
            const newMatriculas = Array.from(matriculas);
            const currentOptions = Array.from(filterSelect.options).map(opt => opt.value).filter(v => v !== "");
            
            if (currentOptions.length !== newMatriculas.length || currentOptions.some(opt => !newMatriculas.includes(opt))) {
                 while (filterSelect.options.length > 1) {
                     filterSelect.remove(1);
                 }
                 newMatriculas.sort().forEach(m => {
                     const option = document.createElement('option');
                     option.value = m;
                     option.textContent = m;
                     filterSelect.appendChild(option);
                 });
            }
            filterSelect.value = selectedMatricula; // Restaurar el valor del filtro
            
            // 2. Filtrado en memoria
            let filteredData = allRoutesData.filter(item => {
                const dateMatch = !selectedDate || item.dateString === selectedDate;
                const matriculaMatch = !selectedMatricula || item.matricula === selectedMatricula;
                return dateMatch && matriculaMatch;
            });

            renderAdminTable(filteredData);
            preparePDFExportOptions(allRoutesData); // Recargar las opciones de exportaci贸n
        }


        /** Renderiza la tabla de resultados del Admin. */
        const renderAdminTable = (data) => {
            const tbody = document.getElementById('admin-results-table-body');
            tbody.innerHTML = '';
            const noDataMessage = document.getElementById('admin-no-data');

            if (data.length === 0) {
                noDataMessage.classList.remove('hidden');
                return;
            }
            noDataMessage.classList.add('hidden');

            // Ordenar por m谩s reciente (timestamp)
            data.sort((a, b) => b.timestamp - a.timestamp); 

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                const date = new Date(item.timestamp);
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${date.toLocaleDateString('es-ES')} ${date.toLocaleTimeString('es-ES').substring(0, 5)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">${item.matricula}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.employee}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.carga}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.destino}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // --- L贸gica de Exportaci贸n a PDF (Usa los datos centralizados) ---
        
        /** Helper: Convierte YYYY-MM-DD a un objeto Date LOCAL en medianoche (00:00:00). */
        const parseLocalMidnight = (dateString) => {
            if (!dateString) return null;
            const parts = dateString.split('-'); // YYYY-MM-DD
            return new Date(parts[0], parts[1] - 1, parts[2]); 
        }

        /** Obtiene el inicio de la semana (Lunes) de una fecha, asegurando 00:00:00 (Local Time). */
        const getStartOfWeek = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0); 
            let day = d.getDay(); 
            day = day === 0 ? 6 : day - 1; 
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff)); 
        }

        /** Agrupa la data por Matr铆cula y Semana y genera los botones de exportaci贸n. */
        const preparePDFExportOptions = (allData) => {
            const container = document.getElementById('export-pdf-list');
            container.innerHTML = '';
            document.getElementById('export-loading-message').classList.add('hidden');

            if (allData.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No hay registros para exportar.</p>';
                return;
            }

            const groupedData = {};

            allData.forEach(item => {
                const date = new Date(item.timestamp);
                const startDateObject = getStartOfWeek(date); 
                
                const startOfWeek = `${startDateObject.getFullYear()}-${String(startDateObject.getMonth() + 1).padStart(2, '0')}-${String(startDateObject.getDate()).padStart(2, '0')}`;
                
                const key = `${item.matricula}_${startOfWeek}`;

                if (!groupedData[key]) {
                    const endOfWeekDate = new Date(startDateObject);
                    endOfWeekDate.setDate(startDateObject.getDate() + 6); 
                    const endOfWeek = `${endOfWeekDate.getFullYear()}-${String(endOfWeekDate.getMonth() + 1).padStart(2, '0')}-${String(endOfWeekDate.getDate()).padStart(2, '0')}`;

                    groupedData[key] = {
                        matricula: item.matricula,
                        startOfWeek: startOfWeek,
                        endOfWeek: endOfWeek,
                        records: []
                    };
                }
                groupedData[key].records.push(item);
            });

            // Ordenar grupos por fecha descendente
            const sortedKeys = Object.keys(groupedData).sort((a, b) => {
                const dateA = parseLocalMidnight(groupedData[a].startOfWeek);
                const dateB = parseLocalMidnight(groupedData[b].startOfWeek);
                if (!dateA || !dateB) return 0;
                return dateB.getTime() - dateA.getTime();
            });
            
            // Generar los botones
            sortedKeys.forEach(key => {
                const group = groupedData[key];
                
                const div = document.createElement('div');
                div.className = 'flex flex-col md:flex-row justify-between items-center p-3 bg-white border border-gray-200 rounded-lg shadow-sm';
                
                const startDateDisplay = parseLocalMidnight(group.startOfWeek)?.toLocaleDateString('es-ES') || 'Fecha Desconocida';
                const endDateDisplay = parseLocalMidnight(group.endOfWeek)?.toLocaleDateString('es-ES') || 'Fecha Desconocida';

                div.innerHTML = `
                    <p class="font-medium text-gray-700 mb-2 md:mb-0 text-sm md:text-base">
                        <span class="font-extrabold text-blue-700 mr-2">${group.matricula}</span>
                        | Semana: ${startDateDisplay} al ${endDateDisplay}
                        <span class="text-xs text-gray-500">(${group.records.length} rutas)</span>
                    </p>
                    <button 
                        onclick="generateWeeklyPDF('${group.matricula}', '${group.startOfWeek}')"
                        class="flex items-center bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm w-full md:w-auto"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-2.25A3.375 3.375 0 0010.5 11.625v2.625m-7.5 1.5h15m-14.5-5.625a.375.375 0 11.75 0 .375.375 0 01-.75 0zm7.5 0a.375 0 11.75 0 .375 0 01-.75 0z" />
                        </svg>
                        Exportar PDF
                    </button>
                `;
                container.appendChild(div);
            });
        }

        /** Genera el PDF Semanal para una Matr铆cula y Semana espec铆fica, usando los datos centralizados. */
        window.generateWeeklyPDF = (matricula, startOfWeek) => {
            
            // Usar el parser para obtener una fecha local consistente (Lunes 00:00:00)
            const startDate = parseLocalMidnight(startOfWeek);
            if (!startDate) {
                 showMessageModal("Error de Fecha", "Fallo al determinar el inicio de la semana.");
                 return;
            }

            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 7); 

            // Filtrar registros de la data global
            const weeklyRecords = allRoutesData.filter(item => {
                const itemDate = parseLocalMidnight(item.dateString); 
                if (!itemDate) return false;

                return item.matricula === matricula && itemDate.getTime() >= startDate.getTime() && itemDate.getTime() < endDate.getTime();
            }).sort((a, b) => a.timestamp - b.timestamp); // Ordenar cronol贸gicamente
            
            if (weeklyRecords.length === 0) {
                showMessageModal("Error", "No se encontraron registros en el rango de fechas especificado para esta matr铆cula.");
                return;
            }
            
            try {
                // @ts-ignore
                const doc = new window.jspdf.jsPDF();
                
                const startOfWeekStr = startDate.toLocaleDateString('es-ES');
                
                const displayEndDate = new Date(endDate);
                displayEndDate.setDate(displayEndDate.getDate() - 1); 
                const endOfWeekStr = displayEndDate.toLocaleDateString('es-ES');

                // Encabezado
                doc.setFontSize(18);
                doc.text(`Reporte Semanal de Rutas`, 14, 22);
                doc.setFontSize(12);
                doc.text(`Matr铆cula: ${matricula}`, 14, 30);
                doc.text(`Per铆odo: ${startOfWeekStr} - ${endOfWeekStr}`, 14, 37);
                doc.setFontSize(10);
                doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES')}`, 14, 44);

                // Preparar datos para la tabla
                const tableColumn = ["Fecha y Hora", "Conductor", "Carga", "Destino"];
                const tableRows = [];

                weeklyRecords.forEach(record => {
                    const date = new Date(record.timestamp);
                    tableRows.push([
                        date.toLocaleDateString('es-ES') + ' ' + date.toLocaleTimeString('es-ES').substring(0, 5),
                        record.employee,
                        record.carga,
                        record.destino
                    ]);
                });

                // Generar tabla
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 50,
                    headStyles: { fillColor: [30, 64, 175] }, 
                    styles: { fontSize: 8 },
                    margin: { top: 50 }
                });

                const fileName = `${matricula}_SEMANA_${startOfWeek}.pdf`;
                doc.save(fileName);
                showMessageModal("Exportaci贸n Exitosa", `Se ha generado el archivo PDF: ${fileName}`);

            } catch (error) {
                console.error("Error durante la generaci贸n del PDF:", error);
                showMessageModal("Error de PDF", "Hubo un error al crear el documento PDF.");
            }
        }
        
        // --- Event Listeners ---

        document.getElementById('form-route').addEventListener('submit', window.saveRoute);
        document.getElementById('form-employee').addEventListener('submit', window.updateEmployeeName);
        document.getElementById('form-admin-password').addEventListener('submit', window.checkAdminPassword);
        document.getElementById('filter-date').addEventListener('change', window.applyAdminFilters);
        document.getElementById('filter-matricula').addEventListener('change', window.applyAdminFilters);
        
        // --- Inicio de la Aplicaci贸n ---
        window.onload = initializeFirebase;

    </script>
</body>
</html>